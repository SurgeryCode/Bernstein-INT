{%- if data -%}
    {%- liquid 
        assign country = localization.country.iso_code | downcase
        assign price = json.prices[country]
        assign _desc = data.description | metafield_tag | replace: '<p>|TABLE|</p>', '|TABLE|' | split: '|TABLE|'
    -%}
    
    {%- capture description -%}
        {% for part in _desc %}
            {%- if part contains '|ENDTABLE|' -%}
                {%- assign subpart = part | split: '|ENDTABLE|' -%}
                {%- assign rows = subpart[0] | split: '</p>' -%}
                <table>
                    {%- for row in rows -%}
                        {%- assign cells = row | remove: '<p>' | split: '|' -%}
                        <tr>
                            {%- for cell in cells -%}
                                <td>{{ cell }}</td>
                            {%- endfor -%}
                        </tr>
                    {%- endfor -%}
                </table>
                {{ subpart[1] }}
            {%- else -%}
                {{ part }}
            {%- endif -%}
        {%- endfor -%}
    {%- endcapture -%}

    {%- if price -%}
        <upsell-item 
            class="upsell__item upsell__item--warranty" 
            data-variant="warranty" 
            data-warranty-id="{{ json.id }}"
            data-warranty-name="{{ 'upsell.warranty' | t }}"
            data-warranty-value="{{ data.name }}">
                <div class="upsell__item-main">
                    <div class="upsell__item-image">
                        {%- render 'svg-icon', name: 'warranty-48' -%}
                    </div>
                    <div class="upsell__item-content">
                        <div>
                            <p class="w-medium">{{ 'upsell.warranty_cta' | t }}</p>
                            <p class="f-12 w-medium gray">{{ data.name }}</p>
                        </div>
                        <div class="price selected">
                            <div class="price__main">
                                <span class="f-24 w-bold">
                                    {%- assign price = price | times: 100 -%}
                                    + {%- render 'price', price: price -%}
                                </span>
                            </div>
                        </div>
                        {%- if description != blank -%}
                            <div class="upsell__item-expand">
                                <button class="text-link f-14 w-medium gray" aria-expanded="false">
                                    <span>{{ 'accessibility.read_more' | t }}</span>
                                    {%- render 'svg-icon', name: 'chevron-down' -%}
                                </button>
                            </div>
                            <div class="upsell__item-description">
                                <div class="richtext richtext--small richtext--table-border f-14">
                                    {{ description }}
                                </div>
                            </div>
                        {%- endif -%}
                    </div>
                    <button 
                        class="upsell__button"
                        data-action="add-warranty"
                        title="{{ 'product.add_to_cart' | t }}"
                        aria-label="{{ 'product.add_to_cart' | t }}">
                            {%- render 'svg-icon', name: 'cart-add' -%}
                            {%- render 'svg-icon', name: 'check' -%}
                    </button>
                </div>
        </upsell-item>
    {%- endif -%}
{%- endif -%}